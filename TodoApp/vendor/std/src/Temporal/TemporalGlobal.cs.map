{ "version": 3, "file": "csharp/std/src/Temporal/TemporalGlobal.cs", "sources": [ "std/temporal/temporal.temper.md" ], "sourcesContent": [ "# Temporal\n\nWe're creating an initial Date type to help with developing\nTemper's machinery to connect to existing Date types in\ntarget languages.\n\nSome facts about the Gregorian calendar.\n\n    /** Indexed by the month number: 1 = January */\n    let daysInMonth = [\n      0,\n      /* January   */ 31,\n      /* February  */ 28, // Special case leap days\n      /* March     */ 31,\n      /* April     */ 30,\n      /* May       */ 31,\n      /* June      */ 30,\n      /* July      */ 31,\n      /* August    */ 31,\n      /* September */ 30,\n      /* October   */ 31,\n      /* November  */ 30,\n      /* December  */ 31,\n    ];\n\n    let isLeapYear(year: Int): Boolean {\n       year % 4 == 0 \u0026\u0026 (year % 100 != 0 || year % 400 == 0)\n    }\n\n    /**\n     * If the decimal representation of \\|num\\| is longer than [minWidth],\n     * then appends that representation.\n     * Otherwise any sign for [num] followed by enough zeroes to bring the\n     * whole length up to [minWidth].\n     *\n     * ```temper\n     * // When the width is greater than the decimal's length,\n     * // we pad to that width.\n     * \u00220123\u0022 == do {\n     *   let sb = new StringBuilder();\n     *   padTo(4, 123, sb);\n     *   sb.toString()\n     * }\n     *\n     * // When the width is the same or lesser, we just use the string form.\n     * \u0022123\u0022 == do {\n     *   let sb = new StringBuilder();\n     *   padTo(2, 123, sb);\n     *   sb.toString()\n     * }\n     *\n     * // The sign is always on the left.\n     * \u0022-01\u0022 == do {\n     *   let sb = new StringBuilder();\n     *   padTo(3, -1, sb);\n     *   sb.toString()\n     * }\n     * ```\n     */\n    let padTo(minWidth: Int, num: Int, sb: StringBuilder): Void {\n      let decimal = num.toString(10);\n      var decimalIndex = String.begin;\n      let decimalEnd = decimal.end;\n      if (decimalIndex \u003c decimalEnd \u0026\u0026 decimal[decimalIndex] == char'-') {\n        sb.append(\u0022-\u0022);\n        decimalIndex = decimal.next(decimalIndex);\n      }\n      var nNeeded = minWidth - decimal.countBetween(decimalIndex, decimalEnd);\n      while (nNeeded \u003e 0) {\n        sb.append('0');\n        nNeeded -= 1;\n      }\n      sb.appendBetween(decimal, decimalIndex, decimalEnd);\n    }\n\n    // Relates months (one-indexed) to numbers used in day-of-week\n    // computations non-leapy.\n    let dayOfWeekLookupTableLeapy: List\u003cInt\u003e = [\n      0, // Not a month\n      0, 3, 4, 0, 2, 5, 0, 3, 6, 1, 4, 6,\n    ];\n    let dayOfWeekLookupTableNotLeapy: List\u003cInt\u003e = [\n      0, // Not a month\n      0, 3, 3, 6, 1, 4, 6, 2, 5, 0, 3, 5,\n    ];\n\nHere's just enough of a Date type to get us started.\n\n    /**\n     * A Date identifies a day in the proleptic Gregorian calendar.\n     * It is unconnected to a time of day or a timezone.\n     */\n    @json\n    @connected(\u0022Date\u0022)\n    export class Date {\n      /** The year.  1900 means 1900. */\n      @connected(\u0022Date::getYear\u0022)\n      public year: Int;\n      /** The month of the year in [1, 12]. */\n      @connected(\u0022Date::getMonth\u0022)\n      public month: Int;\n      /**\n       * The day of the month in [1, 31]\n       * additionally constrained by the length of [month].\n       */\n      @connected(\u0022Date::getDay\u0022)\n      public day: Int;\n\n      @connected(\u0022Date::constructor\u0022)\n      public constructor(year: Int, month: Int, day: Int): Void throws Bubble {\n        if (1 \u003c= month \u0026\u0026 month \u003c= 12 \u0026\u0026\n            1 \u003c= day \u0026\u0026 (\n              if (month != 2 || day != 29) {\n                day \u003c= daysInMonth[month]\n              } else {\n                isLeapYear(year)\n              })) {\n          this.year = year;\n          this.month = month;\n          this.day = day;\n        } else {\n          bubble();\n        }\n      }\n\n      /** An ISO 8601 Date string with dashes like \u00222000-12-31\u0022. */\n      @connected(\u0022Date::toString\u0022)\n      public toString(): String {\n        let sb = new StringBuilder();\n        padTo(4, year, sb);\n        sb.append(\u0022-\u0022);\n        padTo(2, month, sb);\n        sb.append(\u0022-\u0022);\n        padTo(2, day, sb);\n        return sb.toString();\n      }\n\n      /** Parses a Date from an ISO 8601 Date string with dashes like \u00222000-12-21\u0022. */\n      @connected(\u0022Date::fromIsoString\u0022)\n      public static fromIsoString(isoString: String): Date throws Bubble {\n        let end = isoString.end;\n        var strIndex = isoString.prev(isoString.prev(end));\n        // strIndex at '^'\n        // YYYY-MM-^DD\n        let beforeDay = strIndex;\n        strIndex = isoString.prev(strIndex);\n        // YYYY-MM^-DD\n        let afterMonth = strIndex;\n        if (!isoString.hasIndex(afterMonth) || isoString[strIndex] != char'-') {\n          bubble();\n        }\n        strIndex = isoString.prev(isoString.prev(strIndex));\n        // YYYY-^MM-DD\n        let beforeMonth = strIndex;\n        strIndex = isoString.prev(strIndex);\n        // YYYY^-MM-DD\n        if (isoString[strIndex] != char'-' ||\n            !isoString.hasAtLeast(String.begin, strIndex, 4)) {\n          bubble();\n        }\n        let day   = isoString.slice(beforeDay,    end)       .toInt32(10);\n        let month = isoString.slice(beforeMonth,  afterMonth).toInt32(10);\n        let year  = isoString.slice(String.begin, strIndex)  .toInt32(10);\n        return new Date(year, month, day);\n      }\n\n      /**\n       * The count of whole years between the two dates.\n       *\n       * Think of this as floor of the magnitude of a range:\n       *\n       *     ⌊ [start, end] ⌋\n       *\n       * If you think of it as subtraction, you have to reverse\n       * the order of arguments.\n       *\n       *     ⌊ end - start ⌋, NOT ⌊ start - end ⌋\n       *\n       * \u0022Whole year\u0022 is based on month/day calculations, not\n       * day-of-year.  This means that there is one full year\n       * between 2020-03-01 and 2021-03-01 even though, because\n       * February of 2020 has 29 days, 2020-03-01 is the 61st\n       * day of 2020 but 2021-03-01 is only the 60th day of\n       * that year.\n       */\n      @connected(\u0022Date::yearsBetween\u0022)\n      public static let yearsBetween(start: Date, end: Date): Int {\n        let yearDelta = end.year - start.year;\n        let monthDelta = end.month - start.month;\n        yearDelta - (\n            // If the end month/day is before the start's then we\n            // don't have a full year.\n            if (monthDelta \u003c 0 || monthDelta == 0 \u0026\u0026 end.day \u003c start.day) {\n              1\n            } else {\n              0\n            })\n      }\n\n      /** Today's date in UTC */\n      // TODO: take a zone\n      @connected(\u0022Date::today\u0022)\n      public static let today(): Date;\n\n      /**\n       * ISO 8601 weekday number.\n       *\n       * | Number | Weekday  |\n       * | ------ | -------- |\n       * |      1 | Monday   |\n       * |      2 | Tuesday  |\n       * |      3 | Monday   |\n       * |      4 | Thursday |\n       * |      5 | Friday   |\n       * |      6 | Saturday |\n       * |      7 | Sunday   |\n       */\n      @connected(\u0022Date::getDayOfWeek\u0022)\n      public get dayOfWeek(): Int {\n        // Gauss's method.\n        let y = year;\n        let c = if (y \u003e= 0) { y / 100 } else { -(-y / 100) };\n        let yy = y - (c * 100);\n        // See note below about avoiding negative modulus to see why\n        // some of the offsets differ from Wikipedia's rendering of\n        // Gauss's formula.\n        let janFirst = (8 + 5*((yy + 3) % 4) + 3*(yy - 1) + 5*(c % 4)) % 7;\n        let table = if (isLeapYear(y)) {\n          dayOfWeekLookupTableLeapy\n        } else {\n          dayOfWeekLookupTableNotLeapy\n        };\n        let monthOffset = table[month];\n        // Gauss's method produces a number in 0..6 but\n        // ISO assigns 1..7 where all values are the same\n        // except that Sunday is 7 instead of 0.\n        // Below we do (day + 6) since that is equivalent to\n        // (day - 1) where we end up % 7 but avoids any chance\n        // of a negative left operand to `%`.\n        let gaussWeekday = (janFirst + (day + 6) + monthOffset) % 7;\n        if (gaussWeekday == 0) { 7 } else { gaussWeekday }\n      }\n\n      public encodeToJson(p: JsonProducer): Void {\n        p.stringValue(toString());\n      }\n\n      public static decodeFromJson(\n        t: JsonSyntaxTree,\n        ic: InterchangeContext,\n      ): Date throws Bubble {\n        Date.fromIsoString((t as JsonString).content)\n      }\n    };\n\nDates marshal to and from JSON via the ISO string form.\n\n    let {\n      InterchangeContext,\n      JsonProducer,\n      JsonString,\n      JsonSyntaxTree\n    } = import(\u0022../json\u0022);\n\nTODO: an auto-balancing Date builder.\nOther temporal values\nDay of week\n" ], "names": [ "encodeToJson", "this", "p", "t#313", "stringValue", "decodeFromJson", "t", "ic", "t#190", "jsonAdapter", "daysInMonth", "isLeapYear", "year", "return", "t#263", "padTo", "minWidth", "num", "sb", "t#346", "t#348", "t#257", "decimal", "decimalIndex", "decimalEnd", "t#349", "nNeeded", "dayOfWeekLookupTableLeapy", "dayOfWeekLookupTableNotLeapy" ], "mappings": "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" }